// index.js - Bot de WhatsApp con Baileys
// Ejecutar con: node index.js
// Compatible con Replit — usa require (CommonJS)

const { Boom } = require('@hapi/boom');
const { makeWASocket, DisconnectReason, useSingleFileAuthState } = require('@adiwajshing/baileys');
const fs = require('fs');

// Ruta del archivo de sesión
const SESSION_FILE_PATH = './session/auth_info.json';

// Crear carpeta 'session' si no existe
if (!fs.existsSync('./session')) {
    fs.mkdirSync('./session', { recursive: true });
}

// Estado de autenticación (guarda/recupera sesión)
const { state, saveState } = useSingleFileAuthState(SESSION_FILE_PATH);

// Función principal para conectar el bot
async function connectToWhatsApp() {
    const sock = makeWASocket({
        auth: state,
        printQRInTerminal: true, // ← ¡Esto muestra el QR en la consola!
        logger: {
            info: () => {},   // Opcional: silencia logs innecesarios
            warn: () => {},
            error: () => {}
        }
    });

    // Guardar sesión cuando se actualice
    sock.ev.on('creds.update', saveState);

    // Manejar eventos de conexión
    sock.ev.on('connection.update', (update) => {
        const { connection, lastDisconnect } = update;

        if (connection === 'close') {
            // Reconectar si no fue cerrado por logout
            const shouldReconnect = 
                lastDisconnect?.error?.output?.statusCode !== DisconnectReason.loggedOut;
            
            if (shouldReconnect) {
                console.log('🔁 Reconectando...');
                connectToWhatsApp();
            } else {
                console.log('🚫 Sesión cerrada. Borra ./session/auth_info.json y reinicia para escanear QR de nuevo.');
            }
        } else if (connection === 'open') {
            console.log('✅ ¡Bot conectado y funcionando!');
        }
        // El QR se imprime automáticamente gracias a printQRInTerminal: true
    });

    // Escuchar mensajes entrantes
    sock.ev.on('messages.upsert', async ({ messages, type }) => {
        if (type === 'notify') {
            for (const msg of messages) {
                // Aquí luego conectaremos el handler y plugins
                console.log('📩 Mensaje recibido:', msg.content ? msg.content.slice(0, 50) + '...' : msg);
            }
        }
    });

    return sock;
}

// Iniciar el bot
console.log('🤖 Iniciando bot...');
connectToWhatsApp().catch(console.error);
